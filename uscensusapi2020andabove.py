import requests
import pandas as pd
import urllib3
import time
import os
from dotenv import load_dotenv
load_dotenv()

# 1. SSL Warning Suppression
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

api_key = os.getenv("UscensusAPI")
# --- CONFIGURATION ---
API_KEY = api_key
YEAR = "2020"
DATASET = "acs/acs5"
BASE_URL = f"https://api.census.gov/data/{YEAR}/{DATASET}"

# SET THIS TO FALSE WHEN READY TO RUN ALL 758 ZIPS
TRIAL_MODE = True

# (I have put a few here. Paste your full 758 list inside these brackets when ready)
full_zip_list = ['20105', '20106', '20109', '20110', '20111', '20112', '20115', '20117', '20119', '20120', '20121', '20124', '20129', '20130', '20132', '20135', '20136', '20137', '20141', '20143', '20144', '20147', '20148', '20151', '20152', '20155', '20158', '20164', '20165', '20166', '20169', '20170', '20171', '20175', '20176', '20180', '20181', '20184', '20186', '20187', '20190', '20191', '20194', '20197', '20198', '22003', '22015', '22025', '22026', '22027', '22030', '22031', '22032', '22033', '22039', '22041', '22042', '22043', '22044', '22046', '22060', '22066', '22079', '22101', '22102', '22124', '22125', '22134', '22150', '22151', '22152', '22153', '22172', '22180', '22181', '22182', '22191', '22192', '22193', '22201', '22202', '22203', '22204', '22205', '22206', '22207', '22209', '22213', '22301', '22302', '22303', '22304', '22305', '22306', '22307', '22308', '22309', '22310', '22311', '22312', '22314', '22315', '22401', '22405', '22406', '22407', '22408', '22427', '22432', '22435', '22436', '22437', '22438', '22443', '22454', '22460', '22469', '22473', '22476', '22480', '22482', '22485', '22488', '22503', '22504', '22508', '22511', '22514', '22520', '22534', '22535', '22539', '22542', '22546', '22551', '22553', '22554', '22556', '22560', '22567', '22572', '22576', '22578', '22580', '22601', '22602', '22603', '22610', '22611', '22620', '22623', '22624', '22625', '22627', '22630', '22637', '22639', '22640', '22641', '22642', '22643', '22644', '22645', '22650', '22652', '22654', '22655', '22656', '22657', '22660', '22663', '22664', '22701', '22709', '22712', '22713', '22714', '22715', '22716', '22718', '22719', '22720', '22722', '22724', '22726', '22727', '22728', '22731', '22732', '22733', '22734', '22735', '22736', '22737', '22738', '22740', '22742', '22743', '22747', '22749', '22801', '22802', '22810', '22812', '22815', '22821', '22824', '22827', '22830', '22831', '22832', '22834', '22835', '22840', '22841', '22842', '22843', '22844', '22846', '22847', '22849', '22850', '22851', '22853', '22901', '22902', '22903', '22911', '22920', '22922', '22923', '22931', '22932', '22935', '22936', '22937', '22938', '22939', '22940', '22942', '22943', '22947', '22949', '22952', '22958', '22959', '22960', '22963', '22964', '22967', '22968', '22969', '22971', '22972', '22973', '22974', '22976', '22980', '23002', '23004', '23005', '23009', '23011', '23015', '23022', '23024', '23027', '23030', '23032', '23035', '23038', '23039', '23040', '23043', '23047', '23050', '23055', '23056', '23059', '23060', '23061', '23062', '23063', '23065', '23069', '23070', '23071', '23072', '23075', '23076', '23079', '23083', '23084', '23086', '23089', '23092', '23093', '23102', '23103', '23106', '23109', '23111', '23112', '23113', '23114', '23116', '23117', '23120', '23123', '23124', '23128', '23129', '23138', '23139', '23140', '23141', '23146', '23148', '23149', '23150', '23153', '23156', '23168', '23169', '23175', '23176', '23177', '23180', '23181', '23185', '23188', '23192', '23219', '23220', '23221', '23222', '23223', '23224', '23225', '23226', '23227', '23228', '23229', '23230', '23231', '23233', '23234', '23235', '23236', '23237', '23238', '23294', '23301', '23303', '23306', '23308', '23310', '23314', '23315', '23320', '23321', '23322', '23323', '23324', '23325', '23336', '23337', '23350', '23356', '23357', '23359', '23395', '23410', '23415', '23416', '23417', '23418', '23420', '23421', '23427', '23430', '23432', '23433', '23434', '23435', '23436', '23437', '23438', '23442', '23451', '23452', '23453', '23454', '23455', '23456', '23457', '23462', '23464', '23487', '23502', '23503', '23504', '23505', '23507', '23508', '23509', '23510', '23513', '23517', '23518', '23523', '23601', '23602', '23603', '23605', '23606', '23607', '23608', '23661', '23662', '23663', '23664', '23666', '23669', '23690', '23692', '23693', '23696', '23701', '23702', '23703', '23704', '23707', '23803', '23805', '23821', '23824', '23827', '23828', '23829', '23830', '23831', '23832', '23833', '23834', '23836', '23837', '23838', '23839', '23840', '23841', '23842', '23843', '23844', '23845', '23846', '23847', '23850', '23851', '23856', '23857', '23860', '23866', '23867', '23868', '23872', '23874', '23875', '23876', '23878', '23879', '23881', '23882', '23883', '23885', '23887', '23888', '23889', '23890', '23894', '23897', '23898', '23901', '23915', '23917', '23919', '23920', '23921', '23922', '23923', '23924', '23927', '23930', '23934', '23936', '23937', '23938', '23942', '23944', '23947', '23950', '23954', '23958', '23959', '23960', '23962', '23963', '23964', '23966', '23967', '23968', '23970', '23974', '24012', '24013', '24014', '24015', '24016', '24017', '24018', '24019', '24053', '24054', '24055', '24059', '24060', '24064', '24065', '24066', '24067', '24069', '24070', '24072', '24073', '24076', '24077', '24078', '24079', '24083', '24084', '24085', '24087', '24088', '24089', '24090', '24091', '24092', '24095', '24101', '24102', '24104', '24105', '24112', '24120', '24121', '24122', '24124', '24127', '24128', '24133', '24134', '24136', '24137', '24138', '24139', '24141', '24147', '24148', '24149', '24150', '24151', '24153', '24161', '24162', '24165', '24167', '24171', '24174', '24175', '24176', '24179', '24184', '24201', '24202', '24210', '24211', '24216', '24219', '24220', '24221', '24224', '24225', '24226', '24228', '24230', '24236', '24237', '24243', '24244', '24245', '24248', '24250', '24251', '24256', '24258', '24260', '24263', '24266', '24270', '24271', '24273', '24277', '24279', '24280', '24281', '24283', '24290', '24292', '24293', '24301', '24311', '24312', '24313', '24314', '24315', '24317', '24318', '24319', '24323', '24324', '24325', '24326', '24328', '24330', '24333', '24340', '24343', '24347', '24348', '24350', '24351', '24352', '24354', '24360', '24361', '24363', '24366', '24368', '24370', '24374', '24375', '24378', '24380', '24381', '24382', '24401', '24413', '24416', '24421', '24422', '24426', '24430', '24431', '24432', '24435', '24437', '24439', '24440', '24441', '24442', '24445', '24448', '24450', '24457', '24458', '24459', '24460', '24464', '24465', '24467', '24471', '24472', '24473', '24474', '24477', '24479', '24482', '24483', '24484', '24485', '24486', '24487', '24501', '24502', '24503', '24504', '24517', '24521', '24522', '24523', '24526', '24527', '24528', '24529', '24530', '24531', '24536', '24538', '24540', '24541', '24549', '24550', '24551', '24553', '24554', '24555', '24556', '24557', '24558', '24562', '24563', '24565', '24566', '24569', '24571', '24572', '24574', '24577', '24578', '24579', '24580', '24586', '24588', '24589', '24590', '24592', '24593', '24594', '24597', '24599', '24602', '24603', '24605', '24609', '24613', '24614', '24620', '24622', '24630', '24631', '24634', '24637', '24639', '24641', '24646', '24649', '24651', '24656']

# 3. VARIABLES LIST (Parsed from your string)
variable_map = {
    "B19013_001E": "Median_HH_Income",
    "B19301_001E": "Per_Capita_Income",
    "B19081_001E": "Mean_Inc_Low20",
    "B19081_005E": "Mean_Inc_Top5",
    "B17001_001E": "Poverty_Universe_Total",
    "B17001_002E": "Below_Poverty_Level",
    "B23025_003E": "Civilian_Labor_Force",
    "B23025_005E": "Unemployed",
    "B25003_001E": "Tenure_Total_Occupied",
    "B25003_003E": "Renter_Occupied",
    "B25070_007E": "Rent_15_to_19_Percent_Inc",
    "B25070_008E": "Rent_20_to_24_Percent_Inc",
    "B25070_009E": "Rent_25_to_29_Percent_Inc",
    "B25070_010E": "Rent_30_to_34_Percent_Inc",
    "B25004_002E": "Vacancy_For_Rent",
    "B25034_001E": "Structure_Built_Total",
    "B25024_010E": "Units_Structure_20_to_49", 
    "B15003_022E": "Bachelor_Degree",
    "B07003_004E": "Geo_Mobility_Same_County",
    "B01002_001E": "Median_Age"
}

# 4. HELPER FUNCTION: CHUNK LIST
def chunker(seq, size):
    return (seq[pos:pos + size] for pos in range(0, len(seq), size))

# --- MAIN EXECUTION ---

# Create list of variables for URL
var_string = "NAME," + ",".join(variable_map.keys())

# Determine which zips to run
zips_to_run = full_zip_list[:1] if TRIAL_MODE else full_zip_list
print(f"--- STARTING RUN ({'TRIAL' if TRIAL_MODE else 'FULL'}) ---")
print(f"Processing {len(zips_to_run)} ZIP codes...")

all_data_frames = []

# Loop through ZIPs in groups of 50 to avoid URL length errors
batch_size = 50
for i, group in enumerate(chunker(zips_to_run, batch_size)):
    zips_formatted = ",".join(group)
    
    # Construct URL
    url = f"{BASE_URL}?get={var_string}&for=zip%20code%20tabulation%20area:{zips_formatted}&key={API_KEY}"
    
    try:
        response = requests.get(url, verify=False)
        if response.status_code == 200:
            data = response.json()
            # Convert to DF (Skip header row 0 for data)
            chunk_df = pd.DataFrame(data[1:], columns=data[0])
            all_data_frames.append(chunk_df)
            print(f"Batch {i+1}: Success ({len(group)} ZIPs)")
        else:
            print(f"Batch {i+1}: Failed (Status {response.status_code}) - {response.text}")
            
    except Exception as e:
        print(f"Batch {i+1}: Error - {e}")

# --- COMBINE AND SAVE ---
if all_data_frames:
    final_df = pd.concat(all_data_frames, ignore_index=True)
    
    # Rename Columns
    final_df.rename(columns=variable_map, inplace=True)
    final_df.rename(columns={"zip code tabulation area": "ZIP"}, inplace=True)
    
    # Reorder: Put ZIP and NAME first
    cols = ["ZIP", "NAME"] + list(variable_map.values())
    # Ensure we only select columns that exist (in case API returns fewer)
    existing_cols = [c for c in cols if c in final_df.columns]
    final_df = final_df[existing_cols]
    
    print("\n--- PREVIEW ---")
    print(final_df.head().to_string(index=False))
    
    # --- SAVE TO GCS ---
    from google.cloud import storage

    # Get bucket from env or use default (set via Terraform)
    bucket_name = os.getenv("GCS_BUCKET_NAME", "auth-test-proj-481009-data-bucket-8871")
    filename = "virginia_zips_data_trial.csv" if TRIAL_MODE else f"virginia_zips_full_data_{YEAR}.csv"

    print(f"Uploading to GCS Bucket: {bucket_name} as {filename}...")
    
    try:
        storage_client = storage.Client()
        bucket = storage_client.bucket(bucket_name)
        blob = bucket.blob(filename)
        
        # Convert DF to CSV string
        csv_data = final_df.to_csv(index=False)
        blob.upload_from_string(csv_data, content_type='text/csv')
        
        print(f"Successfully uploaded to gs://{bucket_name}/{filename}")
    except Exception as e:
        print(f"ERROR: Failed to upload to GCS: {e}")
else:
    print("\nNo data collected.")